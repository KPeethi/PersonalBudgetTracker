{% extends "base.html" %}

{% block title %}Admin Panel - Expense Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-3">Admin Control Panel</h1>
        <p class="lead">Monitor users, analyze spending patterns, and manage system settings.</p>
    </div>
</div>
<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">System Overview</h5>
                <a href="{{ url_for('export_expenses') }}?all_users=true" class="btn btn-sm btn-outline-info">
                    <i class="bi bi-download me-1"></i> Export All Data
                </a>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h1 class="display-4">{{ total_users }}</h1>
                                <p class="mb-0">Total Users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h1 class="display-4">{{ total_expenses }}</h1>
                                <p class="mb-0">Total Expenses</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h1 class="display-4">{{ active_users }}</h1>
                                <p class="mb-0">Active Users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h1 class="display-4">{{ suspended_users }}</h1>
                                <p class="mb-0">Suspended</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="list-group">
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Total Spending:</span>
                            <span class="badge bg-primary">${{ "%.2f"|format(expense_stats.total_amount or 0) }}</span>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Average Expense:</span>
                            <span class="badge bg-info">${{ "%.2f"|format(expense_stats.avg_amount or 0) }}</span>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Largest Expense:</span>
                            <span class="badge bg-danger">${{ "%.2f"|format(expense_stats.max_amount or 0) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Quick Links</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <a href="{{ url_for('dashboard') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-bar-chart-fill me-2 text-primary"></i>
                            <span>System-wide Analytics</span>
                        </div>
                        <i class="bi bi-chevron-right"></i>
                    </a>
                    <a href="{{ url_for('monthly_summary') }}?all_users=true" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-calendar-month me-2 text-success"></i>
                            <span>Monthly Summary (All Users)</span>
                        </div>
                        <i class="bi bi-chevron-right"></i>
                    </a>
                    <a href="{{ url_for('index') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-cash-stack me-2 text-info"></i>
                            <span>My Expenses</span>
                        </div>
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">User Accounts</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="toggleInactiveUsers" 
                           onclick="toggleInactiveUsersVisibility()">
                    <label class="form-check-label" for="toggleInactiveUsers">Show Inactive</label>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="userTable">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr class="{% if not user.is_active or user.is_suspended %}inactive-user{% endif %}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary rounded-circle text-white d-flex align-items-center justify-content-center me-2" 
                                             style="width: 32px; height: 32px; font-size: 14px;">
                                            {{ user.username[0] | upper }}
                                        </div>
                                        <div>
                                            <div class="fw-bold">{{ user.username }}</div>
                                            <div class="small text-muted">{{ user.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if user.is_suspended %}
                                        <span class="badge bg-danger">Suspended</span>
                                    {% elif not user.is_active %}
                                        <span class="badge bg-warning text-dark">Inactive</span>
                                    {% else %}
                                        <span class="badge bg-success">Active</span>
                                    {% endif %}
                                    
                                    {% if user.is_admin %}
                                        <span class="badge bg-primary ms-1">Admin</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.last_login %}
                                        {{ user.last_login.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        <span class="text-muted">Never</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a href="{{ url_for('user_details', user_id=user.id) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-info-circle"></i>
                                        </a>
                                        
                                        {% if user.is_suspended or not user.is_active %}
                                            <form action="{{ url_for('activate_user', user_id=user.id) }}" method="post" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-outline-success">
                                                    <i class="bi bi-check-circle"></i>
                                                </button>
                                            </form>
                                        {% else %}
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                        data-bs-toggle="dropdown" aria-expanded="false"
                                                        {% if user.id == current_user.id %}disabled{% endif %}>
                                                    Actions
                                                </button>
                                                <ul class="dropdown-menu">
                                                    {% if user.is_admin %}
                                                        <li>
                                                            <form action="{{ url_for('remove_admin', user_id=user.id) }}" method="post">
                                                                <button type="submit" class="dropdown-item" 
                                                                        {% if user.id == current_user.id %}disabled{% endif %}>
                                                                    <i class="bi bi-shield-x me-2 text-danger"></i> Remove Admin
                                                                </button>
                                                            </form>
                                                        </li>
                                                    {% else %}
                                                        <li>
                                                            <form action="{{ url_for('make_admin', user_id=user.id) }}" method="post">
                                                                <button type="submit" class="dropdown-item">
                                                                    <i class="bi bi-shield-check me-2 text-primary"></i> Make Admin
                                                                </button>
                                                            </form>
                                                        </li>
                                                    {% endif %}
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <form action="{{ url_for('deactivate_user', user_id=user.id) }}" method="post">
                                                            <button type="submit" class="dropdown-item" 
                                                                    {% if user.id == current_user.id %}disabled{% endif %}>
                                                                <i class="bi bi-person-dash me-2 text-warning"></i> Deactivate
                                                            </button>
                                                        </form>
                                                    </li>
                                                    <li>
                                                        <button type="button" class="dropdown-item" 
                                                                {% if user.id == current_user.id %}disabled{% endif %}
                                                                data-bs-toggle="modal" data-bs-target="#suspendModal{{ user.id }}">
                                                            <i class="bi bi-slash-circle me-2 text-danger"></i> Suspend
                                                        </button>
                                                    </li>
                                                </ul>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Suspend User Modal -->
                                    <div class="modal fade" id="suspendModal{{ user.id }}" tabindex="-1" aria-labelledby="suspendModalLabel{{ user.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <form action="{{ url_for('suspend_user', user_id=user.id) }}" method="post">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="suspendModalLabel{{ user.id }}">Suspend User: {{ user.username }}</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label for="suspension_reason" class="form-label">Reason for Suspension</label>
                                                            <textarea name="suspension_reason" class="form-control" rows="3" required></textarea>
                                                            <div class="form-text">This reason will be shown to the user when they attempt to log in.</div>
                                                        </div>
                                                        <div class="alert alert-warning">
                                                            <i class="bi bi-exclamation-triangle me-2"></i> Suspending a user will immediately prevent them from accessing their account.
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-danger">Suspend User</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">User Spending Overview</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th class="text-end">Total Spent</th>
                                <th class="text-end">Expenses</th>
                                <th>Last Activity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for spending in user_spending %}
                            <tr>
                                <td>{{ spending.username }}</td>
                                <td class="text-end fw-bold 
                                    {% if spending.total_spent > 1000 %}text-danger
                                    {% elif spending.total_spent > 500 %}text-warning
                                    {% else %}text-success{% endif %}">
                                    ${{ "%.2f"|format(spending.total_spent) }}
                                </td>
                                <td class="text-end">{{ spending.expense_count }}</td>
                                <td>
                                    {% if spending.last_expense_date %}
                                        {{ spending.last_expense_date.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        <span class="text-muted">No expenses</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('user_details', user_id=spending.user_id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-bar-chart-line"></i> Details
                                    </a>
                                    <a href="{{ url_for('export_expenses', user_id=spending.user_id) }}" class="btn btn-sm btn-outline-info">
                                        <i class="bi bi-download"></i> Export
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Hide inactive users by default
    document.addEventListener('DOMContentLoaded', function() {
        // Hide inactive users initially
        const inactiveUsers = document.querySelectorAll('.inactive-user');
        inactiveUsers.forEach(user => {
            user.style.display = 'none';
        });
    });
    
    function toggleInactiveUsersVisibility() {
        const checkbox = document.getElementById('toggleInactiveUsers');
        const inactiveUsers = document.querySelectorAll('.inactive-user');
        
        inactiveUsers.forEach(user => {
            user.style.display = checkbox.checked ? 'table-row' : 'none';
        });
    }
</script>
{% endblock %}